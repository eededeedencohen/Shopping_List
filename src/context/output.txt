CartContext2.js:

import { createContext, useContext, useEffect, useState } from "react";
import { getActiveCart, updateCartData } from "../services/cartService";

const CartContext2 = createContext(null);

export const CartContextProvider2 = ({ children }) => {
  const [cart, setCart] = useState(null);
  // const [supermarketID, setSupermarketID] = useState(null);
  const [isLoadingCartData, setIsLoadingCartData] = useState(false);

  useEffect(() => {
    const loadCart = async () => {
      setIsLoadingCartData(true);
      try {
        const cartData = await getActiveCart();
        setCart(cartData);
        // setSupermarketID(cartData.supermarketID);
      } catch (error) {
        console.error("Failed to load cart", error);
      } finally {
        setIsLoadingCartData(false);
      }
    };

    loadCart();
  }, []);

  const supermarketID = cart?.supermarketID ?? null;   // ← כאן אין שגיאת scope

  /**
   * Syncs the current cart state with the server.
   */
  const syncCartToServer = async () => {
    try {
      if (!cart || !cart._id) throw new Error("No cart or ID found");
      await updateCartData(cart._id, cart);
    } catch (err) {
      console.error("Failed to sync cart", err);
    }
  };

  return (
    <CartContext2.Provider
      value={{
        cart,
        setCart,
        isLoadingCartData,
        supermarketID, 
        // setSupermarketID,
        syncCartToServer,
      }}
    >
      {children}
    </CartContext2.Provider>
  );
};

export const useCart = () => {
  const context = useContext(CartContext2);
  if (!context) throw new Error("CartContext was not provided correctly");
  return context;
};


PriceContext2.js:

import { useCart } from "../context/CartContext2";
import { useEffect, createContext, useContext, useState } from "react";
import {
  getPricesBySupermarketID,
  getPriceListByBarcode,
} from "../services/priceService";

const PriceContext2 = createContext(null);

export const PriceContextProvider2 = ({ children }) => {
  const { supermarketID } = useCart();
  const [pricesBySupermarket, setPricesBySupermarket] = useState([]);
  const [isLoadingPrices, setIsLoadingPrices] = useState(false);
  const [priceListMap, setPriceListMap] = useState(new Map()); // barcode -> list of prices

  /**
   * Loads all prices for a specific supermarket and stores them in context.
   * @param {string|number} supermarketID
   */
  useEffect(() => {
    if (supermarketID == null) return;           // עדין לא נטען cart
    (async () => {
      setIsLoadingPrices(true);
      try {
        const arr = await getPricesBySupermarketID(supermarketID);
        setPricesBySupermarket(arr);
      } catch (e) {
        console.error("Failed to load prices:", e);
        setPricesBySupermarket([]);
      } finally {
        setIsLoadingPrices(false);
      }
    })();
  }, [supermarketID]);

  /**
   * Returns list of prices for a given barcode (from all supermarkets).
   * Uses internal cache to prevent redundant server calls.
   * @param {string} barcode
   * @returns {Promise<Array>}
   */
  const getPriceListByBarcodeCached = async (barcode) => {
    if (priceListMap.has(barcode)) {
      return priceListMap.get(barcode);
    }

    try {
      const prices = await getPriceListByBarcode(barcode);
      priceListMap.set(barcode, prices);
      setPriceListMap(new Map(priceListMap)); // force re-render
      return prices;
    } catch (error) {
      console.error("Failed to load price list for barcode:", error);
      return [];
    }
  };

  return (
    <PriceContext2.Provider
      value={{
        pricesBySupermarket,
        isLoadingPrices,
        // loadPricesForSupermarket,
        getPriceListByBarcodeCached,
      }}
    >
      {children}
    </PriceContext2.Provider>
  );
};

export const usePrices = () => {
  const context = useContext(PriceContext2);
  if (!context) {
    throw new Error("PriceContext was not provided");
  }
  return context;
};



ProductContext2.js:

import { createContext, useContext, useEffect, useState } from "react";
import { getAllProducts } from "../services/productService";
import { getActiveCart } from "../services/cartService";
import { getPricesBySupermarketID } from "../services/priceService";

const ProductContext2 = createContext(null);

/**
 * רשימת הקטגוריות הראשיות במערך, לפי הסדר הרצוי
 */
const allCategories = [
  "משקאות קלים",
  "המקפיא",
  "משקאות חמים",
  "מוצרי תינוקות",
  "שימורים",
  "פארם ותינוקות",
  "תבלינים, אבקות מרק ומרקי אינסטנט",
  "אפייה ביתית",
  "חלב ביצים ומעדנים",
  "מוצרי בסיס לבישול",
  "חטיפים ודגנים",
  "מתוקים ושוקולד",
  "בירות",
  "ניקיון וטואלטיקה",
  "חד פעמי",
  "אלכוהול וקוקטיילים",
  "גבינות",
  "יינות",
  "שמנים ורטבים",
];

/**
 * מיפוי מחרוזת-קטגוריה -> מערך תתי-קטגוריות
 * חשוב שהשמות ב-keys יהיו זהים ל-names שב-allCategories.
 */
const all_sub_categories_map = {
  "משקאות קלים": [
    "משקאות מוגזים",
    "משקאות סויה ושקדים",
    "מים מינרליים וסודה",
    "משקאות אנרגיה",
    "מיצים טבעיים",
  ],
  המקפיא: [
    "בשר ומנות מוכנות קפואות",
    "מוצרי בצק קפואים",
    "גלידות וארטיקים",
    "ירקות קפואים",
    "תוספות קפואות",
    "פירות קפואים",
  ],
  "משקאות חמים": [
    "קפסולות למכונת קפה",
    "תה וחליטות צמחים",
    "קפה טחון ושחור",
    "אייס קפה",
    "תחליף חלב בקפסולות",
    "קפה נמס",
  ],
  "מוצרי תינוקות": [
    "דייסות ודגנים לתינוקות",
    "חיתולים ומגבונים",
    "מוצצים",
    "בקבוקים",
    "קרמים ושמפו לתינוק",
    "תחליפי חלב אם",
    "טיפוח פה לילדים",
  ],
  שימורים: ["מלפפון חמוץ", "תירס", "טונה", "פטריות", "זיתים"],
  "פארם ותינוקות": ["משחת שיניים", "דאודורנטים", "בושם"],
  "תבלינים, אבקות מרק ומרקי אינסטנט": [
    "תבלינים בסיסיים",
    "נמס בכוס (מרקים מיידיים)",
    "אבקות מרק",
    "תערובות תיבול",
    "שמרים, אבקות וקורנפלור",
  ],
  "אפייה ביתית": [
    "תמציות וטעמים",
    "קישוטים",
    "תערובות מוכנות",
    "קמחים וסולת",
    "שמרים, אבקות וקורנפלור",
    "סוכרים וממתיקים",
  ],
  "חלב ביצים ומעדנים": [
    "עוגות וקינוחים מוכנים",
    "מעדני חלב",
    "חמאות ומרגרינות",
    "שמנת וקצפת",
    "קפה קר ובקבוקי קפה",
    "משקאות חלבון",
    "חלב ומשקאות חלב",
    "יוגורטים",
  ],
  "מוצרי בסיס לבישול": ["פתיתים", "פסטות ואטריות", "אורז", "קוסקוס"],
  "חטיפים ודגנים": [
    "חטיפים מלוחים",
    "חטיפים מתוקים",
    "דגני בוקר",
    "קרקרים ופריכיות",
    "חטיפי אנרגיה",
  ],
  "מתוקים ושוקולד": [
    "חטיפי שוקולד",
    "סוכריות",
    "סוכריות ללא סוכר",
    "סוכריות גומי",
    "מארזי שוקולד",
    "מסטיקים",
    "וופלים וביסקוויטים",
    "עוגיות",
    "טבלאות שוקולד",
    "חטיפים מתוקים",
    "ממרח שוקולד",
  ],
  בירות: [
    "בירות כהות",
    "בירות חיטה",
    "בירות אחרות",
    "בירות ללא אלכוהול",
    "בירות לאגר",
    "בירות בוטיק ישראליות",
  ],
  "ניקיון וטואלטיקה": [
    "אבקות ומרככי כביסה",
    "חומרי ניקוי למטבח",
    "חומרי ניקוי לבית",
    "חומרי ניקוי לאמבטיה",
  ],
  "חד פעמי": [
    "שקיות וניילונים",
    "מפיות ומגבות נייר",
    "ניירות ותבניות אפייה",
    "מפות חד-פעמיים",
    "צלחות וקערות",
    "נייר טואלט",
  ],
  "אלכוהול וקוקטיילים": [
    "וויסקי ורום",
    "וודקה וטקילה",
    "קוקטיילים ומשקאות מוכנים",
  ],
  גבינות: [
    "גבינות עובש",
    "גבינות מלוחות",
    "גבינות צהובות",
    "לאבנה",
    "גבינות קשות",
    "גבינות לבנות",
    "גבינות עיזים",
    "גבינות שמנת וממרחים",
  ],
  יינות: ["יינות ללא אלכוהול", "יינות לבנים", "יינות אדומים"],
  "שמנים ורטבים": ["שמנים", "רטבי עגבניות", "חומץ ומיצים", "רטבים כלליים"],
};

const all_sub_categories = allCategories.map(
  (cat) => all_sub_categories_map[cat] || []
);

export const ProductContextProvider2 = ({ children }) => {
  const [products, setProducts] = useState([]);
  const [activeCart, setActiveCart] = useState(null);
  const [pricesBySupermarket, setPricesBySupermarket] = useState({});
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const [activeCategoryIndex, setActiveCategoryIndex] = useState(0);
  const [activeSubCategoryIndex, setActiveSubCategoryIndex] = useState(0);

  /* ■■■ שינוי עיקרי – הסרה של JSON.parse מיותר ■■■ */
  useEffect(() => {
    const fetchProducts = async () => {
      setLoading(true);
      try {
        /* getAllProducts כבר מחזיר מערך של מוצרים */
        const productsData = await getAllProducts();
        const cartData = await getActiveCart();
        const pricesData = await getPricesBySupermarketID(
          cartData.supermarketID
        );
        setProducts(productsData);
        setActiveCart(cartData);
        setPricesBySupermarket(pricesData);
        console.log("productsData", productsData);
        console.log("cartData", cartData);
        console.log("pricesData", pricesData);
      } catch (err) {
        setError(err);
      } finally {
        setLoading(false);
      }
    };

    fetchProducts();
  }, []); // Removed products from dependencies

  return (
    <ProductContext2.Provider
      value={{
        products,
        loading,
        error,
        allCategories,
        all_sub_categories,
        activeCategoryIndex,
        setActiveCategoryIndex,
        activeSubCategoryIndex,
        setActiveSubCategoryIndex,
      }}
    >
      {children}
    </ProductContext2.Provider>
  );
};

export const useProducts = () => {
  const ctx = useContext(ProductContext2);
  if (!ctx) throw new Error("ProductContext was not provided correctly");
  return ctx;
};



